name: "Anchor Push -> Trigger Collector"

on:
  push:
    branches: [ "main" ]
    paths:
      - "latest/anchor_lock.json"

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch collector workflow in collector repo (debug + fail-fast)
        env:
          GH_PAT: ${{ secrets.DISPATCH_TOKEN }}
          OWNER: "KRTeknic"
          REPO: "nba-collector"
          WORKFLOW_FILE: "nba_collector_onefile.yml"
          REF: "main"
        run: |
          set -euo pipefail

          if [ -z "${GH_PAT:-}" ]; then
            echo "Missing secret: DISPATCH_TOKEN"
            exit 1
          fi

          echo "1) Check workflow file exists on target repo"
          curl -sS -D headers.txt -o wf.json \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}"

          cat headers.txt
          echo
          cat wf.json
          echo

          echo "2) Dispatch workflow"
          http_code=$(curl -sS -o dispatch_resp.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}/dispatches" \
            -d "{\"ref\":\"${REF}\"}")

          echo "dispatch http_code=${http_code}"
          echo "dispatch_resp:"
          cat dispatch_resp.json || true
          echo

          # 성공은 204 (No Content) 가 정상
          if [ "${http_code}" != "204" ]; then
            echo "Dispatch failed (expected 204)."
            exit 1
          fi

          echo "Dispatch OK (204)."
