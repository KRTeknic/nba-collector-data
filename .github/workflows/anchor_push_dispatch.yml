name: "Anchor Push -> Trigger Collector"

on:
  push:
    branches: [ "main" ]
    paths:
      - "latest/anchor_lock.json"

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch collector workflow in collector repo (fail-fast)
        env:
          DISPATCH_TOKEN: ${{ secrets.DISPATCH_TOKEN }}
          OWNER: "KRTeknic"
          REPO: "nba-collector"
          WORKFLOW_FILE: "nba_collector_onefile.yml"
          REF: "main"
        run: |
          set -euo pipefail

          if [ -z "${DISPATCH_TOKEN:-}" ]; then
            echo "Missing secret: DISPATCH_TOKEN"
            exit 1
          fi

          echo "Dispatching to ${OWNER}/${REPO} workflow=${WORKFLOW_FILE} ref=${REF}"

          code=$(curl -sS -o resp.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${DISPATCH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}/dispatches" \
            -d "{\"ref\":\"${REF}\"}")

          echo "http_code=${code}"
          cat resp.json || true

          if [ "${code}" != "204" ]; then
            echo "Dispatch failed (expected 204)."
            exit 1
          fi

          echo "Dispatch OK."
